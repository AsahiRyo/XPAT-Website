<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Builder's Challenge - Stack Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Press Start 2P', cursive;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            touch-action: none;
            position: fixed;
        }

        .gameboy-container {
            background: linear-gradient(135deg, #8B9DC3 0%, #6B7DA1 100%);
            border-radius: 20px 20px 40px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4),
                        inset 0 -5px 20px rgba(0, 0, 0, 0.2);
            width: 90vw;
            max-width: 600px;
            max-height: 95vh;
            display: flex;
            flex-direction: column;
            padding: clamp(15px, 3vh, 30px);
            overflow-y: auto;
        }

        .screen-bezel {
            background: #2a2a2a;
            padding: clamp(10px, 2vh, 20px);
            border-radius: 10px;
            box-shadow: inset 0 5px 15px rgba(0, 0, 0, 0.5);
            margin-bottom: clamp(15px, 3vh, 30px);
            flex-shrink: 0;
        }

        .screen-header {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: clamp(6px, 1.2vh, 8px);
            margin-bottom: clamp(5px, 1vh, 10px);
            padding: 0 5px;
        }

        .game-screen {
            background: #9bbc0f;
            width: 100%;
            aspect-ratio: 4/3;
            position: relative;
            overflow: hidden;
            border: 3px solid #1a1a1a;
            box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3);
        }

        canvas {
            width: 100%;
            height: 100%;
            display: block;
            image-rendering: pixelated;
            touch-action: none;
            cursor: pointer;
        }

        .brand {
            text-align: center;
            color: #333;
            font-size: clamp(10px, 2vh, 14px);
            margin: clamp(10px, 2vh, 20px) 0;
            letter-spacing: 2px;
            flex-shrink: 0;
        }

        .controls-hint {
            background: rgba(0, 0, 0, 0.2);
            padding: clamp(10px, 2vh, 15px);
            border-radius: 10px;
            text-align: center;
            color: #333;
            font-size: clamp(6px, 1.2vh, 8px);
            line-height: 1.8;
            margin-bottom: clamp(15px, 2vh, 25px);
            flex-shrink: 0;
        }

        .console-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: clamp(10px, 2vh, 20px) 0;
            flex-shrink: 0;
        }

        .drop-button {
            width: clamp(120px, 25vw, 160px);
            height: clamp(60px, 12vh, 80px);
            border-radius: 15px;
            background: linear-gradient(145deg, #FFD700 0%, #FFA500 100%);
            border: 4px solid #FFE55C;
            color: #000;
            font-size: clamp(12px, 2.5vh, 16px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            touch-action: none;
            transition: all 0.1s;
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.5),
                        inset 0 -3px 10px rgba(0, 0, 0, 0.3);
            font-weight: bold;
            text-transform: uppercase;
        }

        .drop-button:active {
            background: linear-gradient(145deg, #FFA500 0%, #FF8C00 100%);
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(255, 165, 0, 0.6),
                        inset 0 -1px 5px rgba(0, 0, 0, 0.4);
        }

        .start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #9bbc0f;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #0f380f;
            z-index: 10;
            cursor: pointer;
        }

        .start-screen.hidden {
            display: none;
        }

        .game-title {
            font-size: clamp(14px, 3vh, 20px);
            margin-bottom: clamp(10px, 2vh, 15px);
            text-align: center;
            padding: 0 20px;
            line-height: 1.5;
        }

        .game-subtitle {
            font-size: clamp(8px, 1.5vh, 10px);
            margin-bottom: clamp(20px, 4vh, 30px);
            color: #8b0000;
        }

        .start-instruction {
            font-size: clamp(8px, 1.8vh, 11px);
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        @media (orientation: landscape) and (max-height: 600px) {
            .gameboy-container {
                flex-direction: row;
                max-width: 95vw;
                padding: 2vh 3vw;
            }

            .screen-section {
                flex: 1;
                display: flex;
                flex-direction: column;
            }

            .controls-section {
                flex: 0 0 auto;
                display: flex;
                flex-direction: column;
                justify-content: center;
                margin-left: 2vw;
            }

            .screen-bezel {
                margin-bottom: 1vh;
            }

            .brand {
                margin: 1vh 0;
                font-size: clamp(8px, 1.5vh, 12px);
            }

            .controls-hint {
                margin-bottom: 1vh;
                padding: 1vh;
                font-size: clamp(5px, 1vh, 7px);
            }

            .console-controls {
                padding: 0;
            }

            .drop-button {
                width: clamp(100px, 18vw, 140px);
                height: clamp(50px, 10vh, 70px);
            }
        }

        @media (min-width: 768px) and (orientation: portrait) {
            .gameboy-container {
                max-width: 500px;
            }
        }

        .gameboy-container::-webkit-scrollbar {
            width: 0;
            display: none;
        }

        .gameboy-container {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>
    <div class="gameboy-container">
        <div class="screen-section">
            <div class="screen-bezel">
                <div class="screen-header">
                    <span>‚óÑ POWER ON</span>
                    <span>BATTERY FULL ‚ñ∫</span>
                </div>
                <div class="game-screen">
                    <div class="start-screen" id="startScreen">
                        <div class="game-title">BUILDER'S<br>CHALLENGE</div>
                        <div class="game-subtitle">‚ö° STACK PERFECT ‚ö°</div>
                        <div class="start-instruction">TAP TO START</div>
                    </div>
                    <canvas id="gameCanvas"></canvas>
                </div>
            </div>
            
            <div class="brand">GAME BOY ADVANCE SP</div>
            
            <div class="controls-hint">
                DESKTOP: SPACEBAR TO DROP<br>
                MOBILE: TAP DROP BUTTON<br>
                STACK PERFECT! üèóÔ∏è
            </div>
        </div>

        <div class="controls-section">
            <div class="console-controls">
                <button class="drop-button" id="dropButton">
                    DROP<br>BLOCK
                </button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const startScreen = document.getElementById('startScreen');
        const dropButton = document.getElementById('dropButton');

        canvas.width = 480;
        canvas.height = 360;

        let gameStarted = false;
        let gameOver = false;
        let score = 0;
        let level = 1;
        let perfectStreak = 0;
        let maxStreak = 0;
        let totalBlocks = 0;
        let perfectBlocks = 0;
        
        let blocks = [];
        let currentBlock = null;
        let baseBlock = null;
        let particles = [];
        let feedbackText = [];
        
        const BLOCK_HEIGHT = 20;
        const BASE_WIDTH = 200;
        const BASE_SPEED = 2.5;
        const PERFECT_THRESHOLD = 5;
        
        let blockSpeed = BASE_SPEED;
        let blockWidth = BASE_WIDTH;
        let movingRight = true;

        // Audio context for sound effects
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(type) {
            const gainNode = audioContext.createGain();
            gainNode.connect(audioContext.destination);
            gainNode.gain.value = 0.05;

            const oscillator = audioContext.createOscillator();
            oscillator.connect(gainNode);

            switch (type) {
                case 'drop':
                    oscillator.type = 'square';
                    oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
                case 'perfect':
                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(660, audioContext.currentTime);
                    oscillator.start();
                    oscillator.frequency.exponentialRampToValueAtTime(880, audioContext.currentTime + 0.15);
                    oscillator.stop(audioContext.currentTime + 0.15);
                    break;
                case 'good':
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
                case 'fail':
                    oscillator.type = 'sawtooth';
                    oscillator.frequency.setValueAtTime(110, audioContext.currentTime);
                    oscillator.start();
                    oscillator.frequency.exponentialRampToValueAtTime(55, audioContext.currentTime + 0.4);
                    oscillator.stop(audioContext.currentTime + 0.4);
                    break;
                case 'level':
                    const o1 = audioContext.createOscillator();
                    const o2 = audioContext.createOscillator();
                    o1.type = 'square';
                    o2.type = 'square';
                    o1.connect(gainNode);
                    o2.connect(gainNode);
                    o1.frequency.setValueAtTime(523, audioContext.currentTime);
                    o2.frequency.setValueAtTime(659, audioContext.currentTime);
                    o1.start();
                    o2.start(audioContext.currentTime + 0.1);
                    o1.stop(audioContext.currentTime + 0.2);
                    o2.stop(audioContext.currentTime + 0.3);
                    break;
            }
        }

        // Event listeners
        startScreen.addEventListener('click', handleStartClick);
        startScreen.addEventListener('touchstart', handleStartTouch);
        canvas.addEventListener('click', handleCanvasClick);
        canvas.addEventListener('touchstart', handleCanvasTouch);
        dropButton.addEventListener('click', handleDropClick);
        dropButton.addEventListener('touchstart', handleDropTouch);
        document.addEventListener('keydown', handleKeyDown);

        function handleStartClick(e) {
            e.preventDefault();
            startGame();
        }

        function handleStartTouch(e) {
            e.preventDefault();
            startGame();
        }

        function handleCanvasClick(e) {
            if (!gameStarted) {
                startGame();
            } else if (gameOver) {
                resetGame();
            } else {
                dropBlock();
            }
        }

        function handleCanvasTouch(e) {
            e.preventDefault();
            if (!gameStarted) {
                startGame();
            } else if (gameOver) {
                resetGame();
            } else {
                dropBlock();
            }
        }

        function handleDropClick(e) {
            e.preventDefault();
            if (gameStarted && !gameOver) {
                dropBlock();
            }
        }

        function handleDropTouch(e) {
            e.preventDefault();
            if (gameStarted && !gameOver) {
                dropBlock();
            }
        }

        function handleKeyDown(e) {
            if (e.code === 'Space') {
                e.preventDefault();
                if (!gameStarted) {
                    startGame();
                } else if (gameOver) {
                    resetGame();
                } else {
                    dropBlock();
                }
            }
        }

        function startGame() {
            if (!gameStarted) {
                gameStarted = true;
                startScreen.classList.add('hidden');
                initGame();
                gameLoop();
            }
        }

        function resetGame() {
            gameOver = false;
            score = 0;
            level = 1;
            perfectStreak = 0;
            maxStreak = 0;
            totalBlocks = 0;
            perfectBlocks = 0;
            blocks = [];
            particles = [];
            feedbackText = [];
            blockSpeed = BASE_SPEED;
            blockWidth = BASE_WIDTH;
            startScreen.classList.remove('hidden');
            gameStarted = false;
        }

        function initGame() {
            // Create base block
            baseBlock = {
                x: canvas.width / 2 - BASE_WIDTH / 2,
                y: canvas.height - 40,
                width: BASE_WIDTH,
                height: BLOCK_HEIGHT,
                color: '#306230'
            };
            blocks.push(baseBlock);
            
            createNewBlock();
        }

        function createNewBlock() {
            currentBlock = {
                x: 0,
                y: blocks[blocks.length - 1].y - BLOCK_HEIGHT,
                width: blockWidth,
                height: BLOCK_HEIGHT,
                color: getRandomColor(),
                speed: blockSpeed,
                direction: movingRight ? 1 : -1
            };
            movingRight = !movingRight;
        }

        function getRandomColor() {
            const colors = ['#FF6B6B', '#48CFAD', '#FFCE54', '#FC6E51', '#5D9CEC', '#A0D468', '#AC92EC'];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        function dropBlock() {
            if (!currentBlock) return;

            playSound('drop');
            
            const lastBlock = blocks[blocks.length - 1];
            const overlap = getOverlap(currentBlock, lastBlock);
            
            if (overlap <= 0) {
                // Complete miss - game over
                gameOver = true;
                playSound('fail');
                createParticles(currentBlock.x + currentBlock.width / 2, currentBlock.y, '#FF0000', 30);
                return;
            }

            // Calculate precision
            const precision = overlap / Math.min(currentBlock.width, lastBlock.width);
            const hangover = currentBlock.width - overlap;
            
            // Adjust block to overlap area
            if (currentBlock.x < lastBlock.x) {
                currentBlock.x = lastBlock.x;
            } else if (currentBlock.x + currentBlock.width > lastBlock.x + lastBlock.width) {
                currentBlock.x = lastBlock.x + lastBlock.width - overlap;
            }
            currentBlock.width = overlap;
            
            blocks.push(currentBlock);
            totalBlocks++;
            
            // Score and feedback based on precision
            if (Math.abs(hangover) <= PERFECT_THRESHOLD) {
                // Perfect!
                score += 150;
                perfectStreak++;
                perfectBlocks++;
                maxStreak = Math.max(maxStreak, perfectStreak);
                playSound('perfect');
                createFeedback(currentBlock.x + currentBlock.width / 2, currentBlock.y - 10, 'PERFECT!', '#FFD700');
                createParticles(currentBlock.x + currentBlock.width / 2, currentBlock.y, '#FFD700', 25);
            } else if (precision > 0.8) {
                // Great
                score += 100;
                perfectStreak = 0;
                playSound('good');
                createFeedback(currentBlock.x + currentBlock.width / 2, currentBlock.y - 10, 'GREAT!', '#00FF00');
                createParticles(currentBlock.x + currentBlock.width / 2, currentBlock.y, '#00FF00', 15);
            } else if (precision > 0.6) {
                // Good
                score += 75;
                perfectStreak = 0;
                playSound('good');
                createFeedback(currentBlock.x + currentBlock.width / 2, currentBlock.y - 10, 'GOOD', '#FFFF00');
                createParticles(currentBlock.x + currentBlock.width / 2, currentBlock.y, '#FFFF00', 10);
            } else {
                // OK
                score += 50;
                perfectStreak = 0;
                createFeedback(currentBlock.x + currentBlock.width / 2, currentBlock.y - 10, 'OK', '#FFFFFF');
                createParticles(currentBlock.x + currentBlock.width / 2, currentBlock.y, '#FFFFFF', 5);
            }
            
            // Update level and difficulty
            const newLevel = Math.floor(totalBlocks / 10) + 1;
            if (newLevel > level) {
                level = newLevel;
                blockSpeed = BASE_SPEED + (level - 1) * 0.3;
                playSound('level');
                createFeedback(canvas.width / 2, canvas.height / 2, `LEVEL ${level}!`, '#FFD700');
            }
            
            // Gradually decrease block width for more challenge
            blockWidth = Math.max(80, BASE_WIDTH - (totalBlocks * 2));
            
            // Scroll down if tower gets too high
            if (blocks.length > 12) {
                const scrollAmount = BLOCK_HEIGHT;
                blocks.forEach(block => block.y += scrollAmount);
                blocks.shift(); // Remove bottom block
            }
            
            createNewBlock();
        }

        function getOverlap(block1, block2) {
            const left = Math.max(block1.x, block2.x);
            const right = Math.min(block1.x + block1.width, block2.x + block2.width);
            return Math.max(0, right - left);
        }

        function createParticles(x, y, color, count) {
            for (let i = 0; i < count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 6,
                    vy: (Math.random() - 0.5) * 6 - 2,
                    size: 2 + Math.random() * 4,
                    color: color,
                    life: 1,
                    decay: 0.015 + Math.random() * 0.015
                });
            }
        }

        function createFeedback(x, y, text, color) {
            feedbackText.push({
                x: x,
                y: y,
                text: text,
                color: color,
                life: 1,
                decay: 0.02
            });
        }

        function update() {
            if (gameOver) return;

            // Update current block
            if (currentBlock) {
                currentBlock.x += currentBlock.speed * currentBlock.direction;
                
                // Bounce off edges
                if (currentBlock.x <= 0 || currentBlock.x + currentBlock.width >= canvas.width) {
                    currentBlock.direction *= -1;
                    currentBlock.x = Math.max(0, Math.min(currentBlock.x, canvas.width - currentBlock.width));
                }
            }

            // Update particles
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.2; // gravity
                p.life -= p.decay;
                
                if (p.life <= 0) {
                    particles.splice(i, 1);
                }
            }

            // Update feedback text
            for (let i = feedbackText.length - 1; i >= 0; i--) {
                const f = feedbackText[i];
                f.y -= 0.5;
                f.life -= f.decay;
                
                if (f.life <= 0) {
                    feedbackText.splice(i, 1);
                }
            }
        }

        function draw() {
            // Background
            ctx.fillStyle = '#9bbc0f';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (gameOver) {
                ctx.fillStyle = '#0f380f';
                ctx.font = '20px "Press Start 2P"';
                ctx.textAlign = 'center';
                ctx.fillText('GAME OVER!', canvas.width / 2, canvas.height / 2 - 80);
                ctx.font = '12px "Press Start 2P"';
                ctx.fillText(`LEVEL: ${level}`, canvas.width / 2, canvas.height / 2 - 50);
                ctx.fillText(`SCORE: ${score}`, canvas.width / 2, canvas.height / 2 - 25);
                ctx.fillText(`BLOCKS: ${totalBlocks}`, canvas.width / 2, canvas.height / 2);
                ctx.fillText(`PERFECT: ${perfectBlocks}`, canvas.width / 2, canvas.height / 2 + 25);
                ctx.fillText(`MAX STREAK: ${maxStreak}`, canvas.width / 2, canvas.height / 2 + 50);
                ctx.font = '10px "Press Start 2P"';
                ctx.fillText('TAP TO RETRY', canvas.width / 2, canvas.height / 2 + 80);
                return;
            }

            // Draw blocks
            blocks.forEach(block => {
                ctx.fillStyle = block.color;
                ctx.fillRect(block.x, block.y, block.width, block.height);
                
                // Highlight
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fillRect(block.x + 2, block.y + 2, block.width - 4, 3);
                
                // Border
                ctx.strokeStyle = '#0f380f';
                ctx.lineWidth = 2;
                ctx.strokeRect(block.x, block.y, block.width, block.height);
            });

            // Draw current moving block
            if (currentBlock) {
                ctx.fillStyle = currentBlock.color;
                ctx.fillRect(currentBlock.x, currentBlock.y, currentBlock.width, currentBlock.height);
                
                // Highlight
                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                ctx.fillRect(currentBlock.x + 2, currentBlock.y + 2, currentBlock.width - 4, 3);
                
                // Border
                ctx.strokeStyle = '#0f380f';
                ctx.lineWidth = 2;
                ctx.strokeRect(currentBlock.x, currentBlock.y, currentBlock.width, currentBlock.height);
                
                // Drop indicator line
                ctx.strokeStyle = 'rgba(255, 215, 0, 0.5)';
                ctx.lineWidth = 1;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(currentBlock.x + currentBlock.width / 2, currentBlock.y + currentBlock.height);
                ctx.lineTo(currentBlock.x + currentBlock.width / 2, canvas.height);
                ctx.stroke();
                ctx.setLineDash([]);
            }

            // Draw particles
            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.fillRect(p.x - p.size / 2, p.y - p.size / 2, p.size, p.size);
            });
            ctx.globalAlpha = 1;

            // Draw feedback text
            feedbackText.forEach(f => {
                ctx.globalAlpha = f.life;
                ctx.fillStyle = f.color;
                ctx.font = '10px "Press Start 2P"';
                ctx.textAlign = 'center';
                ctx.fillText(f.text, f.x, f.y);
            });
            ctx.globalAlpha = 1;

            // HUD - Top
            ctx.fillStyle = '#0f380f';
            ctx.font = '11px "Press Start 2P"';
            ctx.textAlign = 'left';
            ctx.fillText(`LV:${level}`, 10, 25);
            ctx.fillText(`SCORE:${score}`, 10, 45);
            
            ctx.textAlign = 'right';
            ctx.fillText(`BLOCKS:${totalBlocks}`, canvas.width - 10, 25);
            
            if (perfectStreak > 0) {
                const streakColor = perfectStreak >= 5 ? '#ff0000' : (perfectStreak >= 3 ? '#ff6600' : '#ffd700');
                ctx.fillStyle = streakColor;
                ctx.font = perfectStreak >= 3 ? '12px "Press Start 2P"' : '10px "Press Start 2P"';
                ctx.fillText(`STREAK x${perfectStreak}!`, canvas.width - 10, 50);
            }
            
            // Block size indicator
            ctx.fillStyle = '#0f380f';
            ctx.font = '9px "Press Start 2P"';
            ctx.textAlign = 'center';
            ctx.fillText(`WIDTH:${Math.floor(blockWidth)}`, canvas.width / 2, canvas.height - 10);
        }

        function gameLoop() {
            if (!gameStarted) return;
            update();
            draw();
            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>